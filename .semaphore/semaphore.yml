version: v1.0
name: Flowcrypt Node Core Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:

  - name: Invalidate
    execution_time_limit:
      minutes: 1
    task:
      jobs:
        - name: Invalidate cache
          commands:
            - cache delete sources

  - name: Pull
    execution_time_limit:
      minutes: 2
    task:
      jobs:
        - name: Assemble sources
          commands:
            - mkdir ~/git
            - cd ~/git && git clone --depth=1 https://github.com/FlowCrypt/flowcrypt-browser.git
            - cd ~ && cache store sources ./git

  - name: Install
    execution_time_limit:
      minutes: 2
    task:
      secrets:
        - name: flowcrypt-browser-ci-secrets
      jobs:
        - name: Install & pretest
          commands:
            - npm install -g npm@6.8.0
            - cache restore sources
            - mv ~/test-secrets.json ~/git/flowcrypt-browser/test/test-secrets.json
            - cd ~/git/flowcrypt-browser
            - npm install
            - node --version
            - npm --version
            - ./node_modules/typescript/bin/tsc --version
            - npm run-script pretest
            - cd ~ && cache delete sources && cache store sources ./git

  - name: Test
    execution_time_limit:
      minutes: 6
    task:
      jobs:

        - name: consumer mock
          commands:
            - sudo sh -c "echo '209.250.232.81 cron.flowcrypt.com' >> /etc/hosts && echo '127.0.0.1 google.mock.flowcrypt.com' >> /etc/hosts"
            - cache restore sources
            - cd ~/git/flowcrypt-browser
            - npm run-script test_chrome_consumer

        - name: enterprise mock
          commands:
            - sudo sh -c "echo '209.250.232.81 cron.flowcrypt.com' >> /etc/hosts && echo '127.0.0.1 google.mock.flowcrypt.com' >> /etc/hosts"
            - cache restore sources
            - cd ~/git/flowcrypt-browser
            - npm run-script test_chrome_enteprise

        - name: consumer live gmail
          commands:
            - sudo sh -c "echo '209.250.232.81 cron.flowcrypt.com' >> /etc/hosts"
            - cache restore sources
            - cd ~/git/flowcrypt-browser
            - npm run-script test_chrome_consumer_live_gmail

        - name: quick checks
          commands:
            - cache restore sources
            - cd ~/git/flowcrypt-browser
            - npm run-script test_tslint
            - npm run-script test_patterns
            - npm run-script test_async_stack
            - npm run-script test_buf
